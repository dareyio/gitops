name: Build and Push BBB Images

on:
  workflow_dispatch:
    inputs:
      bbb_version:
        description: 'BBB Version (e.g., 3.0.4)'
        required: true
        default: '3.0.4'
      push_to_ecr:
        description: 'Push images to ECR'
        type: boolean
        default: true
  push:
    branches:
      - main
    paths:
      - 'scripts/build-bbb-images.sh'
      - '.github/workflows/build-bbb-images.yml'
  schedule:
    # Run weekly on Monday at 2 AM UTC to check for updates
    - cron: '0 2 * * 1'

env:
  AWS_REGION: eu-west-2
  ECR_REGISTRY: 586794457112.dkr.ecr.eu-west-2.amazonaws.com
  ECR_REPOSITORY: liveclasses

jobs:
  build-and-push:
    name: Build BBB Images
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
        continue-on-error: true
      - name: Configure AWS credentials (fallback with access keys)
        if: failure() && secrets.AWS_ACCESS_KEY_ID != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Clone BBB Docker repository
        run: |
          git clone --recurse-submodules --depth 1 \
            --branch v${{ github.event.inputs.bbb_version || '3.0.4' }} \
            https://github.com/bigbluebutton/docker.git /tmp/bbb-docker || \
          git clone --recurse-submodules --depth 1 \
            https://github.com/bigbluebutton/docker.git /tmp/bbb-docker
        continue-on-error: false

      - name: Set up BBB Docker environment
        working-directory: /tmp/bbb-docker
        run: |
          cp sample.env .env
          echo "BBB_BUILD_TAG=v${{ github.event.inputs.bbb_version || '3.0.4' }}-release" >> .env
          echo "TAG_BBB=${{ github.event.inputs.bbb_version || '3.0.4' }}" >> .env
          echo "EXTERNAL_IPv4=127.0.0.1" >> .env
          echo "DOMAIN=localhost" >> .env
          echo "SHARED_SECRET=test-secret" >> .env
          echo "ETHERPAD_API_KEY=test-key" >> .env
          echo "ENABLE_HTTPS_PROXY=false" >> .env
          echo "DEV_MODE=false" >> .env

      - name: Generate docker-compose.yml
        working-directory: /tmp/bbb-docker
        run: |
          chmod +x scripts/generate-compose
          ./scripts/generate-compose

      - name: Build base-java image
        working-directory: /tmp/bbb-docker
        run: |
          docker build -t alangecker/bbb-docker-base-java:latest mod/base-java

      - name: Build bbb-web image
        working-directory: /tmp/bbb-docker
        run: |
          docker compose build bbb-web
        timeout-minutes: 30

      - name: Build nginx image (serves HTML5)
        working-directory: /tmp/bbb-docker
        run: |
          docker compose build nginx
        timeout-minutes: 20

      - name: Get image IDs
        working-directory: /tmp/bbb-docker
        id: images
        run: |
          BBB_WEB_ID=$(docker compose images -q bbb-web 2>/dev/null || docker images --format "{{.ID}}" alangecker/bbb-docker-web:* | head -1)
          NGINX_ID=$(docker compose images -q nginx 2>/dev/null || docker images --format "{{.ID}}" alangecker/bbb-docker-nginx:* | head -1)
          echo "bbb_web_id=${BBB_WEB_ID}" >> $GITHUB_OUTPUT
          echo "nginx_id=${NGINX_ID}" >> $GITHUB_OUTPUT
          echo "BBB Web Image ID: ${BBB_WEB_ID}"
          echo "Nginx Image ID: ${NGINX_ID}"

      - name: Tag and push bbb-web image
        if: github.event.inputs.push_to_ecr != 'false'
        run: |
          docker tag ${{ steps.images.outputs.bbb_web_id }} \
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}/bbb-web:${{ github.event.inputs.bbb_version || '3.0.4' }}
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}/bbb-web:${{ github.event.inputs.bbb_version || '3.0.4' }}

      - name: Tag and push bbb-html5 image
        if: github.event.inputs.push_to_ecr != 'false'
        run: |
          docker tag ${{ steps.images.outputs.nginx_id }} \
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}/bbb-html5:${{ github.event.inputs.bbb_version || '3.0.4' }}
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}/bbb-html5:${{ github.event.inputs.bbb_version || '3.0.4' }}

      - name: Summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Images built:" >> $GITHUB_STEP_SUMMARY
          echo "- bbb-web:${{ github.event.inputs.bbb_version || '3.0.4' }}" >> $GITHUB_STEP_SUMMARY
          echo "- bbb-html5:${{ github.event.inputs.bbb_version || '3.0.4' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.push_to_ecr }}" != "false" ]; then
            echo "✅ Images pushed to ECR:" >> $GITHUB_STEP_SUMMARY
            echo "- ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}/bbb-web:${{ github.event.inputs.bbb_version || '3.0.4' }}" >> $GITHUB_STEP_SUMMARY
            echo "- ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}/bbb-html5:${{ github.event.inputs.bbb_version || '3.0.4' }}" >> $GITHUB_STEP_SUMMARY
          fi

