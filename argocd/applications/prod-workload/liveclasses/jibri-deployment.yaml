---
# Jibri Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jibri
  namespace: liveclasses
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jibri
  template:
    metadata:
      labels:
        app: jibri
    spec:
      serviceAccountName: jibri
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - jibri
                        - jvb
                topologyKey: kubernetes.io/hostname
      containers:
        - name: jibri
          image: jitsi/jibri:jibri-8.0-183-g7b406bf-1
          securityContext:
            capabilities:
              add:
                - SYS_ADMIN
          resources:
            requests:
              cpu: "1500m"
              memory: "3Gi"
            limits:
              cpu: "2000m"
              memory: "4Gi"
          volumeMounts:
            - mountPath: /config
              name: jibri-config
            - mountPath: /dev/shm
              name: dshm
          env:
            - name: DISPLAY
              value: ":0"
            - name: JIBRI_XMPP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: jitsi-auth-secrets
                  key: JIBRI_XMPP_PASSWORD
            - name: JIBRI_RECORDER_USER
              value: "recorder"
            - name: JIBRI_RECORDER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: jitsi-auth-secrets
                  key: JIBRI_RECORDER_PASSWORD
            - name: AWS_REGION
              value: "eu-west-2"
            - name: AWS_S3_BUCKET
              value: "darey-v2-prod-jibri-recordings"
            - name: JIBRI_SESSION_ID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: SUPABASE_WEBHOOK_URL
              value: "https://$(SUPABASE_PROJECT_REF).supabase.co"
            - name: SUPABASE_ANON_KEY
              valueFrom:
                secretKeyRef:
                  name: supabase-secrets
                  key: SUPABASE_ANON_KEY
                  optional: true
          command:
            - "/bin/bash"
            - "-c"
            - |
              # Install AWS CLI if not present
              if ! command -v aws &> /dev/null; then
                echo "Installing AWS CLI..."
                apt-get update && apt-get install -y awscli || echo "AWS CLI installation failed, continuing..."
              fi
              # Copy config files
              cp /config/config.json /etc/jitsi/jibri/config.json || true
              cp /config/finalize.sh /etc/jitsi/jibri/finalize.sh || true
              chmod +x /etc/jitsi/jibri/finalize.sh || true
              # Start Jibri
              exec /opt/jitsi/jibri/launch.sh
      volumes:
        - name: jibri-config
          configMap:
            name: jibri-config
        - name: dshm
          emptyDir:
            medium: Memory
            sizeLimit: "2Gi"

---
apiVersion: v1
kind: Service
metadata:
  name: jibri
  namespace: liveclasses
spec:
  selector:
    app: jibri
  ports:
    - protocol: TCP
      port: 2222
      targetPort: 2222
  type: ClusterIP
