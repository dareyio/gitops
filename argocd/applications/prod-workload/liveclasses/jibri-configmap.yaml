---
apiVersion: v1
kind: ConfigMap
metadata:
  name: jibri-config
  namespace: liveclasses
data:
  config.json: |
    {
      "xmpp": {
        "hosts": {
          "domain": "streaming.talentos.darey.io",
          "muc": "conference.streaming.talentos.darey.io",
          "focus": "focus.streaming.talentos.darey.io"
        },
        "client": {
          "username": "jibri",
          "password": "${JIBRI_XMPP_PASSWORD}",
          "domain": "streaming.talentos.darey.io"
        }
      },
      "recording": {
        "recordingDirectory": "/config/recordings",
        "finalizeScript": "/config/finalize.sh"
      },
      "sip": {
        "enabled": false
      },
      "jibri": {
        "xmpp": {
          "environments": [
            {
              "name": "prod environment",
              "xmpp_server_hosts": ["prosody"],
              "xmpp_domain": "streaming.talentos.darey.io",
              "control_login": {
                "domain": "streaming.talentos.darey.io",
                "username": "jibri",
                "password": "${JIBRI_XMPP_PASSWORD}"
              },
              "control_muc": {
                "domain": "streaming.talentos.darey.io",
                "room_name": "JibriBrewery",
                "nickname": "jibri"
              },
              "call_login": {
                "domain": "recorder.streaming.talentos.darey.io",
                "username": "recorder",
                "password": "${JIBRI_RECORDER_PASSWORD}"
              },
              "room_jid_domain_string_to_strip": "conference.",
              "usage_timeout": "0",
              "trust_all_xmpp_certs": true
            }
          ]
        },
        "ffmpeg": {
          "resolution": "1920x1080",
          "frameRate": 30
        },
        "chrome": {
          "flags": [
            "--use-fake-ui-for-media-stream",
            "--use-fake-device-for-media-stream",
            "--disable-dev-shm-usage",
            "--no-sandbox"
          ]
        },
        "recording": {
          "recordingsDirectory": "/config/recordings",
          "finalizeScript": "/config/finalize.sh"
        },
        "stats": {
          "enabled": true
        },
        "webhook": {
          "subscribers": [
            "http://jibri-webhook.liveclasses.svc.cluster.local:8080/webhook"
          ]
        },
        "s3": {
          "enabled": true,
          "bucket": "darey-v2-prod-jibri-recordings",
          "region": "eu-west-2",
          "path": "recordings",
          "credentials": {
            "useIAMRole": true
          }
        }
      }
    }
  finalize.sh: |
    #!/bin/bash
    # Finalize script for Jibri recordings
    # This script is called after recording completes
    # The recording file path is passed as the first argument
    
    RECORDING_FILE="$1"
    SESSION_ID="${JIBRI_SESSION_ID:-unknown}"
    S3_BUCKET="${AWS_S3_BUCKET:-darey-v2-prod-jibri-recordings}"
    S3_REGION="${AWS_REGION:-eu-west-2}"
    
    echo "Finalizing recording: $RECORDING_FILE for session: $SESSION_ID"
    
    if [ ! -f "$RECORDING_FILE" ]; then
      echo "Error: Recording file not found: $RECORDING_FILE"
      exit 1
    fi
    
    # Upload to S3 using AWS CLI (uses IAM role from service account)
    S3_KEY="recordings/${SESSION_ID}/$(basename $RECORDING_FILE)"
    echo "Uploading to s3://${S3_BUCKET}/${S3_KEY}"
    
    aws s3 cp "$RECORDING_FILE" "s3://${S3_BUCKET}/${S3_KEY}" \
      --region "$S3_REGION" \
      --metadata "session-id=${SESSION_ID}" \
      --content-type "video/mp4" || {
      echo "Error: Failed to upload to S3"
      exit 1
    }
    
    # Generate S3 URL
    S3_URL="https://${S3_BUCKET}.s3.${S3_REGION}.amazonaws.com/${S3_KEY}"
    echo "Recording uploaded to: $S3_URL"
    
    # Notify Supabase webhook about completion
    WEBHOOK_URL="${SUPABASE_WEBHOOK_URL:-https://api.supabase.co}"
    curl -X POST "${WEBHOOK_URL}/functions/v1/jibri-webhook" \
      -H "Content-Type: application/json" \
      -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
      -d "{\"sessionId\": \"$SESSION_ID\", \"status\": \"completed\", \"recordingUrl\": \"$S3_URL\", \"file\": \"$RECORDING_FILE\"}" || {
      echo "Warning: Failed to notify webhook, but upload succeeded"
    }
    
    exit 0

