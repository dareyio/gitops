# Darey Score Production Deployment Guide

## Overview

This guide covers the deployment of the Darey Score API to the EKS cluster in the `dareyscore` namespace.

## Prerequisites

1. Terraform applied successfully
2. GitHub repository `dareyio/dareyscore` exists
3. ArgoCD configured and syncing from GitOps repository
4. External Secrets Operator installed and ClusterSecretStore configured
5. Nginx Ingress Controller installed
6. Cert-Manager installed with Let's Encrypt issuer

## Deployment Steps

### 1. Apply Terraform Changes

```bash
cd terraform
terraform init
terraform plan
terraform apply
```

This will create:

- ECR repositories: `dareyscore/dareyscore-api` and `dareyscore/dareyscore-worker`
- GitHub Actions OIDC IAM role
- AWS Secrets Manager secrets (with random passwords)

### 2. Configure GitHub Repository Secrets

After Terraform apply, get the GitHub Actions role ARN:

```bash
terraform output github_actions_role_arn
```

Set this as a GitHub repository secret:

1. Go to `https://github.com/dareyio/dareyscore/settings/secrets/actions`
2. Click "New repository secret"
3. Name: `AWS_ROLE_ARN`
4. Value: The ARN from Terraform output (e.g., `arn:aws:iam::586794457112:role/prod-github-actions-dareyscore-role`)

### 3. Push Code to Trigger CI/CD

The GitHub Actions workflow will:

- Build Docker images for API and Worker
- Push images to ECR with tags: `latest` and `${{ github.sha }}`
- Run tests

### 4. Deploy via ArgoCD

The ArgoCD Application manifest is already created at:
`gitops/argocd/applications/prod/dareyscore.yaml`

ArgoCD will automatically sync and deploy:

1. Namespace
2. PostgreSQL StatefulSet
3. Redis StatefulSet
4. ExternalSecrets (will sync from AWS Secrets Manager)
5. ConfigMap
6. Migration Job
7. API Deployment
8. Worker Deployment
9. Ingress
10. ServiceMonitor

### 5. Verify Deployment

```bash
# Check all pods are running
kubectl get pods -n dareyscore

# Check services
kubectl get svc -n dareyscore

# Check ingress
kubectl get ingress -n dareyscore

# Check ExternalSecrets
kubectl get externalsecrets -n dareyscore

# Check secrets are synced
kubectl get secrets -n dareyscore

# Test API health endpoint
curl https://dareyscore.talentos.darey.io/health

# Check API docs
curl https://dareyscore.talentos.darey.io/docs
```

## Configuration

### Environment Variables

All configuration is managed via:

- **ConfigMap**: `dareyscore-config` (non-sensitive settings)
- **ExternalSecrets**: `dareyscore-api-secrets` and `postgres-secret` (sensitive data from AWS Secrets Manager)

### Secrets Management

Secrets are stored in AWS Secrets Manager and synced to Kubernetes via External Secrets Operator:

- `prod/dareyscore/postgres`: PostgreSQL credentials
- `prod/dareyscore/hmac-secrets`: HMAC secrets for Darey and Xterns platforms
- `prod/dareyscore/jwt-secret`: JWT secret for API authentication
- `prod/dareyscore/redis`: Redis connection details

**Important**: Secret values are generated by Terraform using `random_password` resources and are **never stored in Terraform state**.

### Database Migrations

Migrations run automatically via a Kubernetes Job before the API deployment. The job uses the same API image and runs `alembic upgrade head`.

## Monitoring

- **Metrics**: Prometheus ServiceMonitor configured for `/metrics` endpoint
- **Logs**: Collected automatically via Loki (stdout/stderr)
- **Health Checks**: Liveness and readiness probes configured

## Troubleshooting

### Pods not starting

```bash
# Check pod logs
kubectl logs -n dareyscore <pod-name>

# Check pod events
kubectl describe pod -n dareyscore <pod-name>
```

### ExternalSecrets not syncing

```bash
# Check ExternalSecret status
kubectl describe externalsecret -n dareyscore dareyscore-api-secrets

# Check ClusterSecretStore
kubectl describe clustersecretstore aws-secrets-manager
```

### Database connection issues

```bash
# Check PostgreSQL pod
kubectl logs -n dareyscore -l app=postgres

# Test connection from API pod
kubectl exec -n dareyscore -it <api-pod-name> -- psql -h postgres-service.dareyscore.svc.cluster.local -U dareyscore -d darey_score
```

### Ingress not working

```bash
# Check ingress
kubectl describe ingress -n dareyscore dareyscore-ingress

# Check DNS record
dig dareyscore.talentos.darey.io

# Check certificate
kubectl get certificate -n dareyscore
```

## Rollback

To rollback to a previous version:

1. Update the image tag in `api-deployment.yaml` and `worker-deployment.yaml`
2. Commit and push to GitOps repository
3. ArgoCD will automatically sync

Or manually:

```bash
kubectl set image deployment/dareyscore-api -n dareyscore api=<previous-image-tag>
kubectl set image deployment/dareyscore-worker -n dareyscore worker=<previous-image-tag>
```

## Scaling

To scale the API or Worker:

```bash
kubectl scale deployment dareyscore-api -n dareyscore --replicas=3
kubectl scale deployment dareyscore-worker -n dareyscore --replicas=3
```

Or update the `replicas` field in the deployment manifests and commit to GitOps.

## Security Notes

1. All secrets are stored in AWS Secrets Manager, not in Git
2. External Secrets Operator syncs secrets securely using IRSA
3. GitHub Actions uses OIDC for AWS authentication (no long-lived credentials)
4. Images are scanned on push to ECR
5. Pods run as non-root users
6. Read-only root filesystem (where possible)
7. Network policies can be added for additional isolation
