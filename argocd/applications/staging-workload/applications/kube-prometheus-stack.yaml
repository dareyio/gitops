apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kube-prometheus-stack
  namespace: argocd
  labels:
    cluster.darey.io/environment: staging
    cluster.darey.io/type: workload
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  project: default
  source:
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-prometheus-stack
    targetRevision: 56.0.0
    helm:
      valuesObject:
        prometheus:
          prometheusSpec:
            retention: 2h
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 1000m
                memory: 2Gi
            storageSpec:
              volumeClaimTemplate:
                spec:
                  accessModes: ["ReadWriteOnce"]
                  storageClassName: gp2
                  resources:
                    requests:
                      storage: 20Gi
            externalLabels:
              cluster: staging-workload
            enforcedTargetLimit: 5000
        alertmanager:
          alertmanagerSpec:
            resources:
              requests:
                cpu: 200m
                memory: 256Mi
              limits:
                cpu: 500m
                memory: 512Mi
            secrets:
              - slack-webhook
            config:
              global:
                resolve_timeout: 5m
              route:
                group_by: ["alertname", "namespace"]
                group_wait: 30s
                group_interval: 5m
                repeat_interval: 4h
                receiver: slack-notifications
                routes:
                  - matchers:
                      - severity="critical"
                    receiver: critical-alerts
                    continue: true
              receivers:
                - name: slack-notifications
                  slack_configs:
                    - channel: "#devops-observability"
                      send_resolved: true
                      api_url_file: /etc/alertmanager/secrets/slack-webhook/slack_api_url
                - name: critical-alerts
                  slack_configs:
                    - channel: "#devops-observability"
                      send_resolved: true
                      api_url_file: /etc/alertmanager/secrets/slack-webhook/slack_api_url
        grafana:
          enabled: false
        prometheusOperator:
          resources:
            requests:
              cpu: 200m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
        kubeStateMetrics:
          resources:
            requests:
              cpu: 150m
              memory: 256Mi
            limits:
              cpu: 400m
              memory: 384Mi
          livenessProbe:
            enabled: true
            initialDelaySeconds: 30
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 5
          readinessProbe:
            enabled: true
            initialDelaySeconds: 15
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 5
        prometheus-node-exporter:
          enabled: false
  destination:
    server: https://FB48AC16EE81C0085089AAECDD2874F7.gr7.eu-west-2.eks.amazonaws.com
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true

