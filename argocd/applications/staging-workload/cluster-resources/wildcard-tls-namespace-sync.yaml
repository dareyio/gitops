apiVersion: v1
kind: ConfigMap
metadata:
  name: wildcard-tls-sync-script
  namespace: default
  annotations:
    argocd.argoproj.io/sync-wave: "3"
data:
  sync.sh: |
    #!/bin/bash
    set -e
    SOURCE_SECRET="wildcard-projectlabs-api-talentos-darey-io"
    SOURCE_NAMESPACE="default"

    # Get all namespaces ending with -lab
    kubectl get namespaces -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' | \
      grep -E "-lab$" | while read -r NS; do
        if [ -n "$NS" ]; then
          # Check if secret exists
          if ! kubectl get secret "$SOURCE_SECRET" -n "$NS" >/dev/null 2>&1; then
            echo "Syncing secret to $NS..."
            # Copy secret
            kubectl get secret "$SOURCE_SECRET" -n "$SOURCE_NAMESPACE" -o yaml | \
              sed "s/namespace: $SOURCE_NAMESPACE/namespace: $NS/" | \
              sed '/resourceVersion:/d' | \
              sed '/uid:/d' | \
              sed '/creationTimestamp:/d' | \
              sed '/selfLink:/d' | \
              kubectl apply -f -
            echo "âœ… Synced to $NS"
          fi
        fi
      done
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: wildcard-tls-sync
  namespace: default
  annotations:
    argocd.argoproj.io/sync-wave: "3"
spec:
  schedule: "*/5 * * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: wildcard-tls-sync
          containers:
            - name: sync
              image: bitnami/kubectl:latest
              command:
                - /bin/bash
                - -c
                - |
                  set -e
                  SOURCE_SECRET="wildcard-projectlabs-api-talentos-darey-io"
                  SOURCE_NAMESPACE="default"

                  # Check if source secret exists
                  if ! kubectl get secret "$SOURCE_SECRET" -n "$SOURCE_NAMESPACE" >/dev/null 2>&1; then
                    echo "âŒ Source secret $SOURCE_SECRET not found in namespace $SOURCE_NAMESPACE"
                    exit 1
                  fi

                  # Get source secret's certificate fingerprint (SHA256)
                  SOURCE_FINGERPRINT=$(kubectl get secret "$SOURCE_SECRET" -n "$SOURCE_NAMESPACE" -o jsonpath='{.data.tls\.crt}' | base64 -d | openssl x509 -noout -fingerprint -sha256 2>/dev/null | cut -d'=' -f2 | tr -d ':')

                  if [ -z "$SOURCE_FINGERPRINT" ]; then
                    echo "âŒ Failed to extract certificate fingerprint from source secret"
                    exit 1
                  fi

                  echo "ðŸ” Source certificate fingerprint: ${SOURCE_FINGERPRINT:0:16}..."

                  # Get all namespaces ending with -lab
                  UPDATED_COUNT=0
                  CREATED_COUNT=0
                  SKIPPED_COUNT=0

                  while IFS= read -r NS; do
                    if [ -n "$NS" ]; then
                      # Check if secret exists
                      if kubectl get secret "$SOURCE_SECRET" -n "$NS" >/dev/null 2>&1; then
                        # Secret exists - check if it needs updating
                        TARGET_FINGERPRINT=$(kubectl get secret "$SOURCE_SECRET" -n "$NS" -o jsonpath='{.data.tls\.crt}' | base64 -d | openssl x509 -noout -fingerprint -sha256 2>/dev/null | cut -d'=' -f2 | tr -d ':' || echo "")
                        
                        if [ -z "$TARGET_FINGERPRINT" ]; then
                          echo "âš ï¸  Failed to read certificate from $NS, will update..."
                          TARGET_FINGERPRINT=""
                        fi
                        
                        if [ "$SOURCE_FINGERPRINT" != "$TARGET_FINGERPRINT" ]; then
                          echo "ðŸ”„ Certificate changed in $NS (${TARGET_FINGERPRINT:0:16}... -> ${SOURCE_FINGERPRINT:0:16}...), updating..."
                          kubectl delete secret "$SOURCE_SECRET" -n "$NS" --ignore-not-found=true
                          kubectl get secret "$SOURCE_SECRET" -n "$SOURCE_NAMESPACE" -o yaml | \
                            sed "s/namespace: $SOURCE_NAMESPACE/namespace: $NS/" | \
                            sed '/resourceVersion:/d' | \
                            sed '/uid:/d' | \
                            sed '/creationTimestamp:/d' | \
                            sed '/selfLink:/d' | \
                            kubectl apply -f - >/dev/null 2>&1
                          echo "âœ… Updated certificate in $NS"
                          UPDATED_COUNT=$((UPDATED_COUNT + 1))
                        else
                          SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
                        fi
                      else
                        # Secret doesn't exist - create it
                        echo "ðŸ“ Creating secret in $NS..."
                        kubectl get secret "$SOURCE_SECRET" -n "$SOURCE_NAMESPACE" -o yaml | \
                          sed "s/namespace: $SOURCE_NAMESPACE/namespace: $NS/" | \
                          sed '/resourceVersion:/d' | \
                          sed '/uid:/d' | \
                          sed '/creationTimestamp:/d' | \
                          sed '/selfLink:/d' | \
                          kubectl apply -f - >/dev/null 2>&1
                        echo "âœ… Created secret in $NS"
                        CREATED_COUNT=$((CREATED_COUNT + 1))
                      fi
                    fi
                  done < <(kubectl get namespaces -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' | grep "-lab$")

                  echo ""
                  echo "ðŸ“Š Sync Summary:"
                  echo "   Created: $CREATED_COUNT"
                  echo "   Updated: $UPDATED_COUNT"
                  echo "   Skipped: $SKIPPED_COUNT"
              resources:
                requests:
                  cpu: 50m
                  memory: 64Mi
                limits:
                  cpu: 100m
                  memory: 128Mi
          restartPolicy: OnFailure
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: wildcard-tls-sync
  namespace: default
  labels:
    app: wildcard-tls-sync
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: wildcard-tls-sync
  labels:
    app: wildcard-tls-sync
rules:
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: wildcard-tls-sync
  labels:
    app: wildcard-tls-sync
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: wildcard-tls-sync
subjects:
  - kind: ServiceAccount
    name: wildcard-tls-sync
    namespace: default

