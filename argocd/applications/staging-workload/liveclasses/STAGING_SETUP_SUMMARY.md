# Staging Liveclasses Setup Summary

## âœ… What's Been Created

### 1. Core Configuration Files
- âœ… `liveclasses-config.yaml` - ConfigMap with staging-specific values
  - Domain: `streaming-stg.talentos.darey.io`
  - S3 Bucket: `darey-v2-staging-liveclasses-recordings`
  - Environment: `staging`
  - Jitsi: disabled, BBB: enabled

- âœ… `liveclasses-streaming-ingress.yaml` - Ingress with BBB routes
  - Routes `/bbb/api` â†’ `liveclasses-bbb-api:8080`
  - Routes `/bbb` â†’ `bbb-web:80`
  - Routes `/` â†’ `liveclasses-bbb-api:8080` (default)

- âœ… `liveclasses-recordings-serviceaccount.yaml` - Service account with IAM role
  - IAM Role: `darey-v2-staging-workload-liveclasses-recordings-role`

### 2. BBB Components (in `bbb/` directory)
- âœ… `bbb-api-deployment.yaml` - Custom BBB API service (already running)
- âœ… `bbb-api-service.yaml` - Service for BBB API
- âœ… `bbb-web-deployment.yaml` - BBB HTML5 frontend
- âœ… `bbb-web-service.yaml` - Service for BBB web
- âœ… `bbb-nginx-deployment.yaml` - Nginx reverse proxy
- âœ… `bbb-native-api-deployment.yaml` - BBB native API (updated for staging domain)
- âœ… `freeswitch-daemonset.yaml` - FreeSWITCH for audio/video
- âœ… `freeswitch-service.yaml` - Service for FreeSWITCH
- âœ… `kurento-daemonset.yaml` - Kurento Media Server
- âœ… `kurento-service.yaml` - Service for Kurento

### 3. MongoDB Components
- âœ… `mongodb-statefulset.yaml` - 3-replica MongoDB StatefulSet
- âœ… `mongodb-service.yaml` - Headless service
- âœ… `mongodb-configmap.yaml` - MongoDB configuration
- âœ… `mongodb-secret.yaml` - Kubernetes secret template
- âœ… `mongodb-pdb.yaml` - Pod Disruption Budget
- âœ… `mongodb-backup-cronjob.yaml` - Daily backup to S3
- âœ… `mongodb-backup-serviceaccount.yaml` - Service account for backups

### 4. External Secrets (Updated for Staging)
- âœ… `mongodb-secret-externalsecret.yaml` - References `staging/liveclasses/mongodb`
- âœ… `mongodb-keyfile-externalsecret.yaml` - References `staging/liveclasses/mongodb-keyfile`
- âœ… `bbb-secret-externalsecret.yaml` - References `staging/liveclasses/bbb-api-secret`

### 5. Kustomization Structure
- âœ… `kustomization.yaml` - Root kustomization (references `base`)
- âœ… `base/kustomization.yaml` - Base resources (excludes Jitsi)

## âŒ What's Missing (Prerequisites)

### 1. Terraform - Create Staging Secrets
The following secrets need to be created in AWS Secrets Manager via Terraform:

```hcl
# In terraform/environments/staging/main.tf
# Add to secrets-manager module or create separately:

# staging/liveclasses/mongodb
{
  "root-username": "mongodb-admin",
  "root-password": "<auto-generated>",
  "database-name": "bigbluebutton",
  "database-username": "bbb",
  "database-password": "<auto-generated>"
}

# staging/liveclasses/mongodb-keyfile
{
  "keyfile": "<auto-generated 756 char string>"
}

# staging/liveclasses/bbb-api-secret
{
  "api-secret": "<auto-generated 64 char string>"
}
```

### 2. BBB Images in ECR
BBB images need to be synced to ECR:
- `liveclasses/bbb-web:3.0.4`
- `liveclasses/bbb-html5:3.0.4`
- `liveclasses/freeswitch:3.0.4`
- `liveclasses/kurento-media-server:3.0.4`

Use the script: `/Users/dare/Desktop/xterns/darey-new/scripts/sync-bbb-images-to-ecr.sh`

## ğŸš€ Deployment Steps

### Step 1: Create Terraform Secrets
```bash
cd /Users/dare/Desktop/xterns/darey-new/terraform/environments/staging
terraform plan
terraform apply
```

### Step 2: Sync BBB Images to ECR
```bash
cd /Users/dare/Desktop/xterns/darey-new
./scripts/sync-bbb-images-to-ecr.sh
```

### Step 3: Commit and Push GitOps Changes
```bash
cd /Users/dare/Desktop/xterns/darey-new/gitops
git add .
git commit -m "feat: Add BBB and MongoDB to staging liveclasses"
git push
```

### Step 4: ArgoCD Will Auto-Sync
ArgoCD will automatically detect changes and deploy:
- MongoDB StatefulSet (3 replicas)
- BBB components
- ExternalSecrets will sync secrets from AWS Secrets Manager

### Step 5: Initialize MongoDB Replica Set
After MongoDB pods are running:
```bash
kubectl apply -f bbb/mongodb-init-job.yaml
```

## ğŸ§ª Test Endpoints (After Deployment)

Once everything is deployed:

1. **Health Check**:
   ```bash
   curl https://streaming-stg.talentos.darey.io/bbb/api/health
   ```

2. **BBB API**:
   ```bash
   curl https://streaming-stg.talentos.darey.io/bbb/api/meetings
   ```

3. **BBB Web Interface**:
   ```bash
   open https://streaming-stg.talentos.darey.io/bbb
   ```

## ğŸ“Š Current Status

- âœ… BBB API: 2/2 pods running
- âŒ MongoDB: Not deployed (waiting for secrets)
- âŒ BBB Web: Not deployed (waiting for images)
- âŒ BBB Native API: Not deployed (waiting for MongoDB)
- âŒ FreeSWITCH: Not deployed (waiting for images)
- âŒ Kurento: Not deployed (waiting for images)
- âœ… Ingress: Configured (but services not ready)

## ğŸ”„ Next Actions

1. **Update Terraform** to create staging secrets
2. **Run Terraform apply** for staging
3. **Sync BBB images** to ECR
4. **Commit GitOps changes**
5. **Monitor ArgoCD sync**
6. **Initialize MongoDB replica set**
7. **Test endpoints**

