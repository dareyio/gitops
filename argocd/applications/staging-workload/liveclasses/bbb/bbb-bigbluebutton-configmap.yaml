apiVersion: v1
kind: ConfigMap
metadata:
  name: bbb-bigbluebutton-nginx
  namespace: liveclasses
data:
  bigbluebutton: |
    server {
      # proxied from HAProxy
      listen 48082 http2 proxy_protocol;
      listen 48081 proxy_protocol;

      # optional ports for other reverse proxies
      listen 48087 default_server;
      listen [::]:48087 default_server;

      server_name _;
      access_log /dev/stdout;
      absolute_redirect off;
      root /www/;
      
      # This variable is used instead of $scheme by bigbluebutton nginx include
      # files, so $scheme can be overridden in reverse-proxy configurations.
      set $real_scheme $scheme;

      # opt-out of google's floc tracking
      add_header Permissions-Policy "interest-cohort=()";

      # Include specific rules for record and playback
      include /etc/nginx/bbb/*.nginx;

      # redirect old greenlight v2 room links
      location ~ "/b/([a-z0-9\-]+)" {
        return 302 /rooms/$1;
      }

      # serve default.pdf from /www/
      location = /default.pdf {
        try_files $uri =404;
      }

      # Serve HTML5 client directly from /www/bbb/
      location /bbb {
        alias /www/bbb;
        try_files $uri $uri/ /bbb/index.html;
        index index.html;
      }

      # Serve root path - HTML5 client
      location / {
        root /www;
        try_files $uri $uri/ /index.html;
        index index.html;
      }

      # WebSocket support for HTML5 client
      location /ws {
        proxy_pass http://127.0.0.1:7443;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
      }

      # API proxy to bbb-api service
      location /bigbluebutton/api {
        proxy_pass http://bbb-api:8090/bigbluebutton/api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
      }

      # listen 0.0.0.0:8185; # Fixed IP binding
      listen 127.0.0.1:8185;
    }
