apiVersion: apps/v1
kind: Deployment
metadata:
  name: lab-controller
  namespace: lab-controller
  labels:
    app: lab-controller
    argocd-test: "2026-01-10-verification"
  annotations:
    argocd-image-updater.argoproj.io/image-list: api=586794457112.dkr.ecr.eu-west-2.amazonaws.com/lab-controller/labcontroller-api
    argocd-image-updater.argoproj.io/write-back-method: git
    argocd-image-updater.argoproj.io/git-branch: main
    argocd-image-updater.argoproj.io/match-tag: "^latest$"
    argocd-image-updater.argoproj.io/update-strategy: latest
    argocd-image-updater.argoproj.io/kustomize.image: api=lab-controller-api
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: lab-controller
  template:
    metadata:
      labels:
        app: lab-controller
    spec:
      nodeSelector:
        capacity-type: SPOT
      tolerations:
        - key: "spot"
          operator: "Equal"
          value: "true"
          effect: "NoSchedule"
      serviceAccountName: lab-controller-sa
      containers:
        - name: lab-controller
          image: 586794457112.dkr.ecr.eu-west-2.amazonaws.com/lab-controller/labcontroller-api:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 80
          livenessProbe:
            httpGet:
              path: /health/live
              port: 80
            initialDelaySeconds: 15
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health/ready
              port: 80
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3
          env:
            - name: K8S_MODE
              value: "cluster"
            - name: SUPABASE_JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: supabase-jwt-secret
                  key: SUPABASE_JWT_SECRET
                  optional: true
            - name: AWS_ACCOUNT_ID
              valueFrom:
                secretKeyRef:
                  name: lab-controller-secrets
                  key: AWS_ACCOUNT_ID
                  optional: true
            - name: AWS_REGION
              value: "eu-west-2"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: lab-controller-secrets
                  key: AWS_ACCESS_KEY_ID
                  optional: true
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: lab-controller-secrets
                  key: AWS_SECRET_ACCESS_KEY
                  optional: true
            - name: LAB_ORCHESTRATOR_ENCRYPTION_KEY
              valueFrom:
                secretKeyRef:
                  name: lab-controller-secrets
                  key: LAB_ORCHESTRATOR_ENCRYPTION_KEY
                  optional: false
            - name: LAB_BASE_URL
              value: "https://labcontroller-stg.talentos.darey.io"
            - name: LAB_CONTROLLER_ECR_ROLE_ARN
              value: "arn:aws:iam::586794457112:role/darey-io-v2-lab-staging-workload-lab-controller-ecr-role"
            - name: REDIS_HOST
              valueFrom:
                secretKeyRef:
                  name: lab-controller-redis-secrets
                  key: REDIS_HOST
                  optional: true
            - name: REDIS_PORT
              valueFrom:
                secretKeyRef:
                  name: lab-controller-redis-secrets
                  key: REDIS_PORT
                  optional: true
            - name: REDIS_DB
              value: "1"
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: lab-controller-redis-secrets
                  key: REDIS_PASSWORD
                  optional: true
            - name: REDIS_TLS
              valueFrom:
                secretKeyRef:
                  name: lab-controller-redis-secrets
                  key: REDIS_TLS
                  optional: true
            - name: REDIS_MAX_CONNECTIONS
              value: "150"
            - name: REDIS_SOCKET_TIMEOUT
              value: "15"
            - name: REDIS_CONNECT_TIMEOUT
              value: "10"
            - name: ENABLE_LAB_PASSWORD
              value: "true"
            - name: LAB_TYPES_PATH
              value: "/app/lab-types"
            - name: WILDCARD_TLS_SECRET_NAME
              value: "wildcard-projectlabs-api-talentos-darey-io"
            - name: TRACING_ENABLED
              value: "false"
            - name: OTLP_ENDPOINT
              value: "http://tempo.observability.svc:4317"
            - name: OTLP_INSECURE
              value: "true"
            - name: TELEMETRY_ENVIRONMENT
              value: "prod"
            - name: CORS_ALLOWED_ORIGINS
              value: "https://v2-dev.darey.io,https://darey.io,https://*.darey.io"
            - name: CORS_ALLOW_CREDENTIALS
              value: "true"
            - name: CORS_ALLOW_METHODS
              value: "GET,POST,PUT,DELETE,OPTIONS,PATCH"
            - name: CORS_ALLOW_HEADERS
              value: "Authorization,Content-Type,X-Lab-Session-Id,X-Lab-Session-Token,X-Lab-Auth-Mode"
            - name: MAX_CONCURRENT_LAB_CREATIONS
              value: "15"
            - name: K8S_CLIENT_QPS
              value: "50"
            - name: K8S_CLIENT_BURST
              value: "100"
            - name: RECONCILIATION_ENABLED
              value: "true"
            - name: RECONCILIATION_INTERVAL
              value: "300"
            - name: RECONCILIATION_NAMESPACES
              value: "jupyter-lab,ubuntu-lab,vscode-lab,postgresql-lab"
          resources:
            requests:
              cpu: "200m"
              memory: "512Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"
      restartPolicy: Always
