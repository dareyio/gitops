apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kube-prometheus-stack
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  project: default
  source:
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-prometheus-stack
    targetRevision: 56.0.0
    helm:
      valuesObject:
        prometheus:
          prometheusSpec:
            retention: 30d
            nodeSelector:
              capacity-type: SPOT
            tolerations:
              - key: "spot"
                operator: "Equal"
                value: "true"
                effect: "NoSchedule"
            resources:
              requests:
                cpu: 500m
                memory: 1Gi
              limits:
                cpu: 2000m
                memory: 4Gi
            storageSpec:
              volumeClaimTemplate:
                spec:
                  accessModes: ["ReadWriteOnce"]
                  storageClassName: gp2-eks-csi
                  resources:
                    requests:
                      storage: 100Gi
            externalLabels:
              cluster: ops
              prometheus_replica: $(POD_NAME)
            additionalScrapeConfigs:
              - job_name: "federate-staging-workload"
                honor_labels: true
                metrics_path: "/federate"
                scheme: https
                tls_config:
                  insecure_skip_verify: true
                params:
                  "match[]":
                    - '{__name__=~".+"}'
                static_configs:
                  - targets:
                      - "prometheus-stg.talentos.darey.io"
                    labels:
                      source_cluster: "staging-workload"
              - job_name: "federate-prod-workload"
                honor_labels: true
                metrics_path: "/federate"
                scheme: https
                tls_config:
                  insecure_skip_verify: true
                params:
                  "match[]":
                    - '{__name__=~".+"}'
                static_configs:
                  - targets:
                      - "prometheus-prod-workload.talentos.darey.io"
                    labels:
                      source_cluster: "prod-workload"
        alertmanager:
          enabled: true
          alertmanagerSpec:
            nodeSelector:
              capacity-type: SPOT
            tolerations:
              - key: "spot"
                operator: "Equal"
                value: "true"
                effect: "NoSchedule"
            resources:
              requests:
                cpu: 200m
                memory: 256Mi
              limits:
                cpu: 1000m
                memory: 512Mi
            storage:
              volumeClaimTemplate:
                spec:
                  accessModes: ["ReadWriteOnce"]
                  storageClassName: gp2-eks-csi
                  resources:
                    requests:
                      storage: 10Gi
            secrets:
              - slack-webhook
            config:
              global:
                resolve_timeout: 5m
              route:
                group_by: ["alertname", "cluster", "namespace"]
                group_wait: 30s
                group_interval: 5m
                repeat_interval: 4h
                receiver: "slack-notifications"
                routes:
                  - match:
                      severity: critical
                    receiver: "critical-alerts"
                    continue: true
              receivers:
                - name: "slack-notifications"
                  slack_configs:
                    - channel: "#devops-observability"
                      send_resolved: true
                      api_url_file: /etc/alertmanager/secrets/slack-webhook/slack_api_url
                - name: "critical-alerts"
                  slack_configs:
                    - channel: "#devops-observability"
                      send_resolved: true
                      api_url_file: /etc/alertmanager/secrets/slack-webhook/slack_api_url
                      title: "{{ .GroupLabels.alertname }}"
                      text: >-
                        {{ range .Alerts }}
                        *Alert:* {{ .Annotations.summary }}
                        *Description:* {{ .Annotations.description }}
                        *Severity:* {{ .Labels.severity }}
                        *Cluster:* {{ .Labels.cluster }}
                        *Namespace:* {{ .Labels.namespace }}
                        {{ end }}
        grafana:
          enabled: false
        prometheusOperator:
          nodeSelector:
            capacity-type: SPOT
          tolerations:
            - key: "spot"
              operator: "Equal"
              value: "true"
              effect: "NoSchedule"
          resources:
            requests:
              cpu: 200m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
        kubeStateMetrics:
          resources:
            requests:
              cpu: 150m
              memory: 256Mi
            limits:
              cpu: 400m
              memory: 384Mi
        prometheus-node-exporter:
          enabled: true
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi
  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
