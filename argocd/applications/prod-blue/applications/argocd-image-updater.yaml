apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: argocd-image-updater
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  project: default
  source:
    repoURL: https://argoproj.github.io/argo-helm
    chart: argocd-image-updater
    targetRevision: 0.9.1
    helm:
      valuesObject:
        config:
          registries:
            - name: AWS ECR
              prefix: 586794457112.dkr.ecr.eu-west-2.amazonaws.com
              api_url: https://586794457112.dkr.ecr.eu-west-2.amazonaws.com
              ping: no
              default: true
          git:
            writeBackMethod: git
            branch: main
            commitMessageTemplate: |
              build: update {{.AppName}} image {{.ImageName}} to {{.NewTag}}
              [ci skip]
            pull:
              enabled: true
              interval: 1m
        serviceAccount:
          create: true
          annotations:
            eks.amazonaws.com/role-arn: arn:aws:iam::586794457112:role/darey-io-v2-lab-prod-blue-external-secrets-operator-role
        gitSecret:
          create: false
          name: argocd-repo-ssh
          key: sshPrivateKey
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi
  destination:
    # NOTE: Update this to prod-blue cluster endpoint after cluster is created
    server: https://05EAD20A36B7EEE44B5F80407DFE359B.sk1.eu-west-2.eks.amazonaws.com
    namespace: argocd
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true

