apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kube-prometheus-stack
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  project: default
  source:
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-prometheus-stack
    targetRevision: 56.0.0
    helm:
      valuesObject:
        prometheus:
          prometheusSpec:
            retention: 2h
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 1000m
                memory: 2Gi
            storageSpec:
              volumeClaimTemplate:
                spec:
                  accessModes: ["ReadWriteOnce"]
                  storageClassName: gp2-eks-csi
                  resources:
                    requests:
                      storage: 20Gi
            externalLabels:
              cluster: green
            remoteWrite:
              - url: http://thanos-receive.monitoring.svc.cluster.local:10902/api/v1/receive
                queueConfig:
                  maxSamplesPerSend: 1000
                  batchSendDeadline: 5s
                  maxRetries: 3
                  minBackoff: 30ms
                  maxBackoff: 100ms
            thanos:
              objectStorageConfig:
                key: thanos.yaml
                name: thanos-objstore-config
              serviceAccount: prometheus
              serviceAccountAnnotations:
                eks.amazonaws.com/role-arn: arn:aws:iam::586794457112:role/darey-io-v2-lab-prod-green-prometheus-thanos-role
        alertmanager:
          alertmanagerSpec:
            resources:
              requests:
                cpu: 200m
                memory: 256Mi
              limits:
                cpu: 500m
                memory: 512Mi
            secrets:
              - slack-webhook
              - whatsapp-webhook
            config:
              global:
                resolve_timeout: 5m
              route:
                group_by: ["alertname", "namespace"]
                group_wait: 30s
                group_interval: 5m
                repeat_interval: 4h
                receiver: slack-notifications
                routes:
                  - matchers:
                      - severity="critical"
                    receiver: critical-alerts
                    continue: true
              receivers:
                - name: slack-notifications
                  slack_configs:
                    - channel: "#devops-observability"
                      send_resolved: true
                      api_url_file: /etc/alertmanager/secrets/slack-webhook/slack_api_url
                - name: slack-critical
                  slack_configs:
                    - channel: "#devops-observability"
                      send_resolved: true
                      api_url_file: /etc/alertmanager/secrets/slack-webhook/slack_api_url
                - name: critical-alerts
                  slack_configs:
                    - channel: "#devops-observability"
                      send_resolved: true
                      api_url_file: /etc/alertmanager/secrets/slack-webhook/slack_api_url
                  webhook_configs:
                    - url: "https://api.example.com/whatsapp/webhook"
                      http_config:
                        basic_auth:
                          username: placeholder_username
                          password_file: /etc/alertmanager/secrets/whatsapp-webhook/whatsapp_api_token
                      send_resolved: true
                - name: whatsapp-critical
                  webhook_configs:
                    - url: "https://api.example.com/whatsapp/webhook"
                      http_config:
                        basic_auth:
                          username: placeholder_username
                          password_file: /etc/alertmanager/secrets/whatsapp-webhook/whatsapp_api_token
                      send_resolved: true
        grafana:
          enabled: false

        prometheusOperator:
          resources:
            requests:
              cpu: 200m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi

        kubeStateMetrics:
          resources:
            requests:
              cpu: 150m
              memory: 256Mi
            limits:
              cpu: 400m
              memory: 384Mi
          livenessProbe:
            enabled: true
            initialDelaySeconds: 30
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 5
          readinessProbe:
            enabled: true
            initialDelaySeconds: 15
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 5

        nodeExporter:
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 300m
              memory: 256Mi

        prometheus-node-exporter:
          enabled: false

  destination:
    # NOTE: Update this to prod-green cluster endpoint after cluster is created
    # Get endpoint from: terraform output -json | jq -r '.eks_cluster_endpoints.value.green'
    server: https://kubernetes.default.svc
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
